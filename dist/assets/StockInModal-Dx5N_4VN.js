import{u as O,i as R,j as e,X,S as J,D as K,aL as Q,aM as _,f as A,bo as G}from"./index-BMA--0RW.js";import{r as g,b as W}from"./react-vendor-Bv8thS0I.js";import{C as k}from"./CurrencyInput-DaWIS5Fg.js";import"./supabase-C1Qlw3jS.js";const re=({purchaseOrder:p,onClose:w,allProducts:L,grades:Y,gradeValues:Z})=>{const[x,D]=g.useState([]),[$,M]=g.useState(!1),[q,S]=g.useState({}),[y,I]=g.useState({}),[P,F]=g.useState(!1),{showToast:N}=O(),{user:T}=R(),[f,B]=g.useState([]),[C,V]=g.useState([]);g.useEffect(()=>{(async()=>{const[s,a]=await Promise.all([Q(),_()]);B(s),V(a)})()},[]);const E=g.useMemo(()=>p.items.every(o=>!o.hasImei),[p.items]);g.useEffect(()=>{const o=L.filter(t=>t.purchaseOrderId===p.id),s=p.items.flatMap(t=>{const i=o.filter(r=>r.purchaseItemId===t.id).reduce((r,c)=>r+c.stock,0),n=t.quantity-i;if(n<=0)return[];const j={purchaseItemId:t.id,itemDescription:t.productDetails.model,serialNumber:"",imei1:"",imei2:"",condition:t.productDetails.condition||"Novo",batteryHealth:100,warranty:t.productDetails.warranty||"1 ano",storageLocation:t.productDetails.storageLocation||"Estoque Principal",costPrice:t.unitCost,additionalCostPrice:t.additionalUnitCost,markup:null,salePrice:null,wholesalePrice:null,minimumStock:t.minimumStock,isApple:t.productDetails.brand==="Apple",barcode:t.barcodes&&t.barcodes.length>0?t.barcodes[0]:"",controlByBarcode:t.controlByBarcode};return E?[{...j,quantity:n}]:Array.from({length:n},()=>({...j,quantity:1}))});if(s.length===0){N("Todos os itens desta compra já foram lançados no estoque.","info"),w(!1);return}D(s);const a=s.some(t=>!t.isApple&&t.minimumStock&&t.minimumStock>0);F(a)},[p,L,w,N,E]);const m=(o,s,a)=>{const t=[...x];let i={...t[o]};if(y[o]?.[s]){const n={...y};n[o]&&(delete n[o][s],Object.keys(n[o]).length===0&&delete n[o],I(n))}if(s==="markup"){const n=a===""?null:parseFloat(String(a));if(isNaN(n)&&n!==null)return;i.markup=n;const j=i.costPrice+i.additionalCostPrice;if(j>0&&i.markup!==null){const r=j*(1+i.markup/100);i.salePrice=parseFloat(r.toFixed(2)),i.salePrice>0&&S(c=>({...c,[o]:!1}))}}else if(s==="salePrice"){const n=a===null?null:Number(a);i.salePrice=n;const j=i.costPrice+i.additionalCostPrice;if(j>0&&i.salePrice!==null&&i.salePrice>0){const r=(i.salePrice/j-1)*100;i.markup=isFinite(r)?parseFloat(r.toFixed(2)):0}else i.markup=null;i.salePrice!==null&&i.salePrice>0&&S(r=>({...r,[o]:!1}))}else if(s==="batteryHealth"){let n=parseInt(String(a),10);isNaN(n)&&(n=0),n<0&&(n=0),n>100&&(n=100),i[s]=n}else if(s==="minimumStock"){const n=parseInt(String(a),10);i[s]=n>0?n:1}else i[s]=a;t[o]=i,D(t)},H=async()=>{let o=!1;const s={},a={},t={};if(x.forEach((r,c)=>{const l=r.serialNumber?.trim();l&&(t[l]||(t[l]=[]),t[l].push(c));const h=r.imei1?.trim();h&&(a[h]||(a[h]=[]),a[h].push(c));const d=r.imei2?.trim();d&&(a[d]||(a[d]=[]),a[d].push(c))}),Object.values(t).forEach(r=>{r.length>1&&(o=!0,r.forEach(c=>{s[c]||(s[c]={}),s[c].serialNumber=!0}))}),Object.values(a).forEach(r=>{r.length>1&&(o=!0,r.forEach(c=>{s[c]||(s[c]={});const l=x[c];l.imei1&&a[l.imei1]===r&&(s[c].imei1=!0),l.imei2&&a[l.imei2]===r&&(s[c].imei2=!0),l.imei1&&a[l.imei1].length>1&&(s[c].imei1=!0),l.imei2&&a[l.imei2].length>1&&(s[c].imei2=!0)}))}),o){I(s),N("Foram encontrados números de série ou IMEIs duplicados nesta lista. Corrija os campos destacados.","error");return}const i={};let n=!1;for(const[r,c]of x.entries())(c.salePrice===null||c.salePrice<=0)&&(i[r]=!0,n=!0);if(S(i),n){N("O preço de venda deve ser preenchido e maior que zero.","error");return}M(!0);const j=x.map(r=>{const c=p.items.find(l=>l.id===r.purchaseItemId);return{brand:c.productDetails.brand,category:c.productDetails.category,model:c.productDetails.model,color:c.productDetails.color,price:r.salePrice,wholesalePrice:r.wholesalePrice||0,costPrice:r.costPrice,additionalCostPrice:r.additionalCostPrice,stock:r.quantity,serialNumber:r.serialNumber,imei1:r.imei1,imei2:r.imei2,batteryHealth:r.batteryHealth,condition:r.condition,warranty:r.warranty,storageLocation:r.storageLocation,purchaseItemId:r.purchaseItemId,createdBy:T?.name||"Keiler",supplierId:p.supplierId,origin:p.isCustomerPurchase?"Comprado de Cliente":"Compra",minimumStock:P&&!r.isApple?r.minimumStock:void 0,barcodes:r.barcode?[r.barcode]:[]}});try{await G(p.id,j),N(`Estoque da compra #${p.displayId} lançado com sucesso!`,"success"),w(!0)}catch(r){let c=r.message||"Falha ao lançar estoque.";try{const l=JSON.parse(c);if(l.code==="DUPLICATE_ENTRIES"){const h={};x.forEach((d,b)=>{const{duplicates:v}=l;d.imei1&&(v.imei1.includes(d.imei1)||v.imei2.includes(d.imei1))&&(h[b]||(h[b]={}),h[b].imei1=!0),d.imei2&&(v.imei2.includes(d.imei2)||v.imei1.includes(d.imei2))&&(h[b]||(h[b]={}),h[b].imei2=!0),d.serialNumber&&v.serialNumber.includes(d.serialNumber)&&(h[b]||(h[b]={}),h[b].serialNumber=!0)}),I(h),c="Existem produtos já cadastrados no sistema com os mesmos IMEIs ou Serial Number. Verifique os campos destacados."}}catch{}N(c,"error"),M(!1)}},u="w-full p-2 border rounded bg-transparent border-border focus:ring-success focus:border-success text-sm",U=()=>e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"text-left text-xs text-muted bg-surface-secondary sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 min-w-[200px]",children:"Descrição"}),e.jsx("th",{className:"p-2 text-center",children:"Qtd."}),e.jsx("th",{className:"p-2",children:"Condição"}),e.jsx("th",{className:"p-2",children:"Local"}),P&&e.jsx("th",{className:"p-2",children:"Estoque Mín."}),e.jsx("th",{className:"p-2",children:"Preço de Custo"}),e.jsx("th",{className:"p-2",children:"Markup %"}),e.jsx("th",{className:"p-2",children:"Preço de Venda"}),e.jsx("th",{className:"p-2",children:"Preço ATC"})]})}),e.jsx("tbody",{children:x.map((o,s)=>e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("td",{className:"p-2",children:o.itemDescription}),e.jsx("td",{className:"p-2 text-center",children:o.quantity}),e.jsx("td",{className:"p-2",children:e.jsx("select",{value:o.condition,onChange:a=>m(s,"condition",a.target.value),className:`${u} h-9`,children:f.length===0?e.jsx("option",{children:"Carregando..."}):e.jsxs(e.Fragment,{children:[o.condition&&!f.some(a=>a.name.toLowerCase()===o.condition?.toLowerCase())&&e.jsx("option",{value:o.condition,children:o.condition}),f.map(a=>e.jsx("option",{value:a.name,children:a.name},a.id))]})})}),e.jsx("td",{className:"p-2",children:e.jsx("select",{value:o.storageLocation,onChange:a=>m(s,"storageLocation",a.target.value),className:`${u} h-9`,children:C.length===0?e.jsx("option",{children:"Carregando..."}):e.jsxs(e.Fragment,{children:[o.storageLocation&&!C.some(a=>a.name.toLowerCase()===o.storageLocation?.toLowerCase())&&e.jsx("option",{value:o.storageLocation,children:o.storageLocation}),C.map(a=>e.jsx("option",{value:a.name,children:a.name},a.id))]})})}),P&&e.jsx("td",{className:"p-2",children:e.jsx("input",{type:"number",disabled:o.isApple,value:o.minimumStock||"",onChange:a=>m(s,"minimumStock",a.target.value),className:`${u} h-9 w-20 text-center disabled:bg-gray-50`})}),e.jsx("td",{className:"p-2",children:A(o.costPrice)}),e.jsx("td",{className:"p-2 w-28",children:e.jsx("input",{type:"number",step:"0.01",value:o.markup===null?"":o.markup,onChange:a=>m(s,"markup",a.target.value),className:`${u} h-9`})}),e.jsx("td",{className:"p-2 w-36",children:e.jsx(k,{value:o.salePrice,onChange:a=>m(s,"salePrice",a),className:`${u} h-9 ${q[s]?"border-danger":""}`})}),e.jsx("td",{className:"p-2 w-36",children:e.jsx(k,{value:o.wholesalePrice,onChange:a=>m(s,"wholesalePrice",a),className:`${u} h-9`,placeholder:"Opcional"})})]},s))})]}),z=()=>{const o=x.some(s=>s.isApple&&s.condition==="Seminovo");return e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"text-left text-xs text-muted bg-surface-secondary sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2",children:"Descrição"}),e.jsx("th",{className:"p-2",children:"IMEI 1"}),e.jsx("th",{className:"p-2",children:"IMEI 2"}),e.jsx("th",{className:"p-2",children:"S/N"}),e.jsx("th",{className:"p-2",children:"Condição"}),o&&e.jsx("th",{className:"p-2",children:"Bateria %"}),e.jsx("th",{className:"p-2",children:"Local"}),P&&e.jsx("th",{className:"p-2",children:"Estoque Mín."}),e.jsx("th",{className:"p-2",children:"Custo"}),e.jsx("th",{className:"p-2",children:"Markup %"}),e.jsx("th",{className:"p-2",children:"Venda"}),e.jsx("th",{className:"p-2",children:"ATC"})]})}),e.jsx("tbody",{children:x.map((s,a)=>e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("td",{className:"p-2 text-xs",children:s.itemDescription}),e.jsx("td",{className:"p-2",children:e.jsx("input",{type:"text",value:s.imei1,onChange:t=>m(a,"imei1",t.target.value),className:`${u} h-9 ${y[a]?.imei1?"border-danger bg-red-50":""}`})}),e.jsx("td",{className:"p-2",children:e.jsx("input",{type:"text",value:s.imei2,onChange:t=>m(a,"imei2",t.target.value),className:`${u} h-9 ${y[a]?.imei2?"border-danger bg-red-50":""}`})}),e.jsx("td",{className:"p-2",children:e.jsx("input",{type:"text",value:s.serialNumber,onChange:t=>m(a,"serialNumber",t.target.value),className:`${u} h-9 ${y[a]?.serialNumber?"border-danger bg-red-50":""}`})}),e.jsx("td",{className:"p-2",children:e.jsx("select",{value:s.condition,onChange:t=>m(a,"condition",t.target.value),className:`${u} h-9`,children:f.length===0?e.jsx("option",{children:"Carregando..."}):e.jsxs(e.Fragment,{children:[s.condition&&!f.some(t=>t.name.toLowerCase()===s.condition?.toLowerCase())&&e.jsx("option",{value:s.condition,children:s.condition}),f.map(t=>e.jsx("option",{value:t.name,children:t.name},t.id))]})})}),o&&e.jsx("td",{className:"p-2",children:s.isApple&&s.condition==="Seminovo"?e.jsx("input",{type:"number",value:s.batteryHealth,onChange:t=>m(a,"batteryHealth",t.target.value),className:`${u} h-9 w-20 text-center`}):e.jsx("span",{className:"text-muted text-center block",children:"-"})}),e.jsx("td",{className:"p-2",children:e.jsx("select",{value:s.storageLocation,onChange:t=>m(a,"storageLocation",t.target.value),className:`${u} h-9`,children:C.length===0?e.jsx("option",{children:"Carregando..."}):e.jsxs(e.Fragment,{children:[s.storageLocation&&!C.some(t=>t.name.toLowerCase()===s.storageLocation?.toLowerCase())&&e.jsx("option",{value:s.storageLocation,children:s.storageLocation}),C.map(t=>e.jsx("option",{value:t.name,children:t.name},t.id))]})})}),P&&e.jsx("td",{className:"p-2",children:e.jsx("input",{type:"number",disabled:s.isApple,value:s.minimumStock||"",onChange:t=>m(a,"minimumStock",t.target.value),className:`${u} h-9 w-20 text-center disabled:bg-gray-50`})}),e.jsx("td",{className:"p-2",children:A(s.costPrice)}),e.jsx("td",{className:"p-2 w-28",children:e.jsx("input",{type:"number",step:"0.01",value:s.markup===null?"":s.markup,onChange:t=>m(a,"markup",t.target.value),className:`${u} h-9`})}),e.jsx("td",{className:"p-2 w-36",children:e.jsx(k,{value:s.salePrice,onChange:t=>m(a,"salePrice",t),className:`${u} h-9 ${q[a]?"border-danger":""}`})}),e.jsx("td",{className:"p-2 w-32",children:e.jsx(k,{value:s.wholesalePrice,onChange:t=>m(a,"wholesalePrice",t),className:`${u} h-9`,placeholder:"Opc."})})]},a))})]})};return W.createPortal(e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-[100] p-4",children:e.jsxs("div",{className:"bg-surface rounded-lg shadow-xl w-full max-w-screen-2xl max-h-[95vh] flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 border-b border-border",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold text-primary",children:["Lançar Compra #",p.displayId," no Estoque"]}),e.jsxs("p",{className:"text-sm text-muted",children:["Fornecedor: ",p.supplierName]})]}),e.jsx("button",{onClick:()=>w(!1),className:"p-1 text-muted hover:text-danger",children:e.jsx(X,{className:"h-6 w-6"})})]}),e.jsx("div",{className:"flex-1 overflow-auto border-t border-b border-border",children:E?U():z()}),e.jsx("div",{className:"flex justify-end items-center p-4 border-t border-border mt-auto",children:e.jsxs("button",{onClick:H,disabled:$,className:"px-6 py-2 bg-success text-white rounded-md hover:bg-success/90 font-semibold disabled:bg-muted flex items-center gap-2",children:[$?e.jsx(J,{className:"h-5 w-5"}):e.jsx(K,{className:"h-5 w-5"}),"Lançar no Estoque"]})})]})}),document.body)};export{re as default};
